{% extends "layout.html" %}
{% block main %}
<div class="table-responsive">
	<table id="maintable" class="table table-striped display nowrap" style="position: relative; z-index: 0;">
	  <thead>
		<tr>
			<th class="troopnames">{{troop.name}}<br/><span class="heading">{{heading}}</span></th>
			{% for part in badge_parts %}
			<th class="rotate"><div id="part-{{part.idx}}">{{part.idx}}. {{part.short_desc}}<br/></div></th>
			{% endfor %}
		</tr>
	  </thead>
	  <tbody>
		{% for person in persons %}{% set iperson = loop.index0 %}{% set isleader = troop_persons[iperson].leader %}
		<tr class="{{person.key.urlsafe()}}">
		<td class="name-field troopnames" id="name{{person.key.urlsafe()}}" data-leader="{% if isleader %}1{% else %}0{% endif %}" title="{{person.getname()}}{% if isleader %} (Ledare){% endif %}{%if person.removed %} borttagen i scoutnet{%endif%}">
			<a href="{{baselink+person.key.urlsafe()+ '/'}}">
			{{loop.index}}:{{person.getnameWithStatus()}}{% if isleader %}(L){% endif %}
			</a>
		</td>
		{% for part in badge_parts %} {# name is meeting, id is the person #}{% set ipart = loop.index0 %}
			<td><input title="{{part.short_desc}}: {{person.getname()}}" 
                 class="attendance-cb checkbox big-checkbox" name="cbpart"
                 id="{{person.key.urlsafe()}}:{{part.idx}}" type="checkbox"
                 {%if parts_progress[ipart][iperson]%}checked="" disabled=""{% endif %}/></td>
		{% endfor %}
		</tr>
		{% endfor %}
	  </tbody>
	</table>
</div>
<!-- Full table of badge for reference. Normally hidden -->
<div class="table-responsive" id="badgetable" hidden>
	<table class="table table-striped display nowrap" style="position: relative; z-index: 0;">
	  <thead>
		<tr>
			<th class="short_desc">Del</th>
			<th class="long_desc">Beskrivning</th>
		</tr>
	  </thead>
	  <tbody>
		{% for part in badge_parts %}
		<tr><td>{{part.idx}}. {{part.short_desc}}</td><td>{{part.long_desc}}</td></tr>
		{% endfor %}
	  </tbody>
	</table>
</div>
<div class="divider-vertical well">
    <button class="btn btn-g btn-warning saveinfo" id="saveall">Spara</button>
    <button class="btn btn-g btn-info " id="showinfo">MÃ¤rkesinfo</button>
</div>

<script>
$(document).ready(function() {
    function compileCheckedState() {
        // Get all checked check boxes as part_id:person_id
        var checkboxes = $('input:checkbox[name="cbpart"]');
        console.log(checkboxes)
        var checkedParts = [];
        for (var cb=0; cb < checkboxes.length; cb++)
		{
			if (checkboxes[cb].checked)
			{
                checkedParts.push(checkboxes[cb].id);
			}
		}
        checkedParts.sort()
        return checkedParts;
    }

    var initChecked = compileCheckedState();
    console.log("There are " + initChecked.length + " checked boxes");
    console.log(initChecked[0])

	$("#showinfo").click(function(event) {
        // Toggle description
        console.log("Toggle badge explanation via showinfo")
        $("#badgetable").toggle()
    });

	$("#saveall").click(function(event) {
        var button = event.target;
        var nowChecked = compileCheckedState();
        var newChecks = []
        for (var i=0; i < nowChecked.length; i++)
		{
            if (!initChecked.includes(nowChecked[i])) {
                newChecks.push(nowChecked[i])
            }
		}
        console.log("New: " + newChecks.length)
        var update = newChecks.join(",")
        var fd = new FormData();
		fd.append('action', 'saveparts');
		fd.append('update', update);
		$(button).addClass('data-save-pending');
		$.ajax({
			url:'./',
			data: fd,
			processData: false,
			contentType: false,
			type: 'POST',
			success: function(data) { if (data === "ok") {
				resetDirtyButton($(button));
				location.reload(); // Reload page with stored data
				}
			}
		});
	});

    function resetDirtyButton(btn) {
		btn.removeClass('data-dirty data-save-pending');
	}

	var maintable = $('#maintable');
		maintable.dataTable({
		scrollX:true,
		scrollY:true,
		paging:false,
		ordering:false,
		info:false,
		fixedColumns:true,
		fixedHeader:false, // doesn't work with scrolling
		searching:false,
		bScrollCollapse:true,
		bScrollAutoCss:true,
		bAutoWidth:true
		//responsive:true
    });
	setTimeout(function (){
		// hack/fix for webkit to match sizes after css has been applied
		maintable.fnAdjustColumnSizing();
	}, 10);

});

</script>
{% endblock %}
