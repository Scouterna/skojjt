"use strict";var __awaiter=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function c(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("main"),t=document.getElementById("whoami"),o=location.origin+"/api/";let n=null,r=!1,i=!1;const a=(e,t)=>__awaiter(void 0,void 0,void 0,(function*(){const o=yield fetch(e,t);if(!o.ok)throw o;return yield o.json()})),c=(e,t,n)=>__awaiter(void 0,void 0,void 0,(function*(){const r=o+e;t||(t={}),t.headers||(t.headers={}),t.headers.Authorization="Bearer "+(n||localStorage.getItem("ScoutID-JWT-Token"));const i=yield fetch(r,t);if(i.ok)return yield i.json();if(498!==i.status){const e=i.json();try{yield e}catch(e){throw i}throw yield e}if(n)throw i;if(!(yield s(!1)))throw i;t.headers.Authorization="Bearer "+localStorage.getItem("ScoutID-JWT-Token");const a=yield fetch(r,t);if(!a.ok){const e=a.json();try{yield e}catch(e){throw a}throw yield e}return yield a.json()})),l=e=>__awaiter(void 0,void 0,void 0,(function*(){r=!1,t.innerText="Inte inloggad";const o=c("jwt/verify_token",{},e);try{yield o}catch(e){throw console.error(e.error||e),e}const n=yield o;if(!1===n.user)throw new Error("No user");const a=n.data.karer?Object.values(n.data.karer):[];let l=null;return a.length>2?l=a.slice(0,a.length-1).join(", ")+" och "+a[a.length-1]:a.length>0&&(l=a.join(" och ")),t.innerText="Inloggad som "+n.data.name+(l?" fr책n "+l:""),r=!0,i=n.admin,!0})),s=e=>__awaiter(void 0,void 0,void 0,(function*(){const o=localStorage.getItem("ScoutID-JWT-Token");if(o)try{yield l(o)}catch(e){localStorage.removeItem("ScoutID-JWT-Token")}if(!r){if(!n)return console.error("Loggin failed, as no config was received"),!1;if(!n.jwturl)return console.error("Loggin failed, as there is no jwturl in the received config"),!1;let o=a(n.jwturl,{credentials:"include"});try{yield o}catch(e){if(!e.json)return console.error(e),t.innerText="Inte inloggad",!1;o=e.json();try{yield o}catch(e){return console.error(e),t.innerText="Inte inloggad",!1}}const i=yield o;if(i.ok){try{yield l(i.token)}catch(e){return console.error(e),t.innerText="Inte inloggad",!1}localStorage.setItem("ScoutID-JWT-Token",i.token)}!r&&e&&(location.href=i.url)}return r&&("#!/login/"===location.hash.substr(0,9)?location.hash="#!/"+location.hash.substr(9):"#!/login"===location.hash?location.hash="#!/":e&&h()),r})),d=t=>{e.setAttribute("data-section",t)},u=()=>d("mainmenu"),h=()=>__awaiter(void 0,void 0,void 0,(function*(){if(document.body.classList.toggle("guest",!r),document.body.classList.toggle("admin",i),d(""),!r){switch(location.hash){case"#!/login":return s(!0);case"#!/":case"":return u()}return"#!/login/"===location.hash.substr(0,9)?s(!0):u()}switch(location.hash){case"#!/":case"":return u();case"#!/import":d("import");break;case"#!/logout":return localStorage.removeItem("ScoutID-JWT-Token"),r=!1,t.innerText="Inte inloggad",void(location.hash="#!/")}}));window.addEventListener("hashchange",h);const g=e=>new Promise(t=>setTimeout(t,e)),f=()=>__awaiter(void 0,void 0,void 0,(function*(){const e=document.getElementById("import_kar_id"),t=document.getElementById("import_kar_api_key");let o=+e.value,n=t.value.trim();if("https://"===n.substr(0,8)){let e=null;const t=[new RegExp("^https://([1-9][0-9]*):([0-9a-f]+)@www.scoutnet.se/api/group/memberlist$"),new RegExp("^https://www.scoutnet.se/api/group/memberlist?id=([1-9][0-9]*)&(?:amp;)?key=([0-9a-f]+)(?:&|$)")];for(const o of t)if(e=o.exec(n),e)break;if(e){if(o>0&&o!==+e[1])return void alert("Du angav kar-id: "+o+", men urln inneh책ll k책r-id: "+e[1]);o=+e[1],n=e[2]}}if(o<1)return void alert("K책r-id saknas");if(n.length<1)return void alert("Api-nyckel saknas");d("loading");const r=(i="import",a={karId:o,apiKey:n},__awaiter(void 0,void 0,void 0,(function*(){return c(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})})));var i,a;try{yield r}catch(e){console.error(e),alert(e.error||e),d("import")}const l=yield r;try{yield(s=l,__awaiter(void 0,void 0,void 0,(function*(){if(!s.ok)throw s;const e=document.getElementById("ajax-content");if(e.innerHTML=s.html,d("ajax-loaded"),s.refrechUrl){let t=s;for(;t.refrechUrl;){if(t.delay&&(yield g(1e3*t.delay)),t=yield c(t.refrechUrl),!t.ok)throw t;if(t.html)e.innerHTML=t.html;else if(t.append){const o=document.createElement("div");o.innerHTML=t.append,e.append(o)}}}})))}catch(e){!1===e.ok&&e.error?(console.error(e.error),alert(e.error),d("import")):console.error(e)}var s;location.hash="!#/kar/"+o}));__awaiter(void 0,void 0,void 0,(function*(){document.getElementById("login-button").addEventListener("click",e=>{location.hash.length>3&&"#!/"===location.hash.substr(0,3)&&(e.preventDefault(),location.hash="#!/login/"+location.hash.substr(3))}),document.getElementById("import_kar_button").addEventListener("click",f),"skojjt.webservices.scouterna.net"!==location.hostname&&("skojjt-staging.webservices.scouterna.net"===location.hostname?document.title+=" Stage":document.title+=" Dev"),n=yield a("/api/config"),yield s(!1),yield h()}))});
//# sourceMappingURL=es6.js.map
